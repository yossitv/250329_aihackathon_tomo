<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>右手ミギーデモ</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <video id="videoElement" autoplay playsinline></video>
  <div id="errorMsg"></div>
  <div id="speechText">...</div>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <script src="handDrawing.js"></script>
  <script>
    const videoElement = document.getElementById('videoElement');
    const errorMsg = document.getElementById('errorMsg');
    const speechText = document.getElementById('speechText');

    // Three.jsの初期化
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const handGroup = new THREE.Group();
    scene.add(handGroup);

    const eyeGroup = new THREE.Group();
    const mouthGroup = new THREE.Group();

    const eyeGeometry = new THREE.SphereGeometry(0.05, 32, 32);
    const eyeMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
    const eye = new THREE.Mesh(eyeGeometry, eyeMaterial);
    const pupilGeometry = new THREE.SphereGeometry(0.02, 32, 32);
    const pupilMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
    const pupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
    pupil.position.z = 0.03;
    eye.add(pupil);
    eyeGroup.add(eye);

    const mouthGeometry = new THREE.CircleGeometry(0.03, 32);
    const mouthMaterial = new THREE.MeshBasicMaterial({ color: 0xff3333 });
    const mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
    mouth.rotation.x = -Math.PI / 2;
    mouthGroup.add(mouth);

    scene.add(eyeGroup);
    scene.add(mouthGroup);
    camera.position.z = 1;

    // 手の関節を表す3Dオブジェクトの作成
    const joints = [];
    for (let i = 0; i < 21; i++) {
      const jointGeo = new THREE.SphereGeometry(0.01, 16, 16);
      const jointMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
      const joint = new THREE.Mesh(jointGeo, jointMat);
      handGroup.add(joint);
      joints.push(joint);
    }

    // HandDrawingコンポーネントの初期化
    const handDrawing = new HandDrawing({
      videoElement: videoElement,
      errorMsgElement: errorMsg,
      speechTextElement: speechText,
      onHandUpdate: (landmarks) => {
        // 手のランドマークを処理して3Dオブジェクトを更新
        for (let i = 0; i < landmarks.length; i++) {
          const lm = landmarks[i];
          const x = (lm.x - 0.5) * 2;
          const y = -(lm.y - 0.5) * 2;
          const z = -lm.z;
          joints[i].position.set(x, y, z);
        }
        
        // 目と口の位置を更新
        const tip = landmarks[12]; // 中指の先端
        const palm = landmarks[0]; // 手のひらの中心
        eyeGroup.position.set((tip.x - 0.5) * 2, -(tip.y - 0.5) * 2, -tip.z);
        mouthGroup.position.set((palm.x - 0.5) * 1.7, -(palm.y - 0.5) * 0.6, -palm.z);
      }
    });

    // MediaPipeの初期化と開始
    handDrawing.initMediaPipe();
    handDrawing.startCamera();

    // アニメーションループ
    function animate() {
      requestAnimationFrame(animate);
      
      // 音声レベルに応じて口のサイズを変更
      const audioLevel = handDrawing.getAudioLevel();
      const scale = Math.min(2.5, 0.5 + audioLevel * 3);
      mouth.scale.y = scale;
      
      renderer.render(scene, camera);
    }
    animate();

    // ページ離脱時にリソースを解放
    window.addEventListener('beforeunload', () => {
      handDrawing.dispose();
    });
  </script>
</body>

</html>